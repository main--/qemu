# -*- Mode: Python -*-
#
# Copyright (c) 2021, 2022 Oracle and/or its affiliates.
#
# This work is licensed under the terms of the GNU GPL, version 2.
# See the COPYING file in the top-level directory.

##
# = CPR - CheckPoint and Restart
##

{ 'include': 'common.json' }

##
# @CprMode:
#
# @reboot: checkpoint can be cpr-load'ed after a host reboot.
# @restart: checkpoint can be cpr-load'ed after restarting qemu.
#
# Since: 7.1
##
{ 'enum': 'CprMode',
  'data': [ 'none', 'reboot', 'restart' ] }

##
# @cpr-save:
#
# Pause the VCPUs, and create a checkpoint of the virtual machine device state
# in @filename.  Unlike snapshot-save, this command completes synchronously,
# saves state to an ordinary file, does not save guest block device blocks,
# and does not require that guest RAM be saved in the file.  The caller must
# not modify guest block devices between cpr-save and cpr-load.
#
# cpr-save requires that qemu was started with -cpr-enable for @mode.
#
# If @mode is 'reboot', the checkpoint remains valid after a host reboot.
# The guest RAM memory-backend should be shared and non-volatile across
# reboot, else it will be saved to the file.  To resume from the checkpoint,
# issue the quit command, reboot the system, start qemu using the same
# arguments plus -S, and issue the cpr-load command.
#
# If @mode is 'restart', the checkpoint remains valid after restarting
# qemu using a subsequent cpr-exec.  Guest RAM must be backed by a
# memory-backend-file with share=on.
# To resume from the checkpoint, issue the cpr-load command.
#
# @filename: name of checkpoint file
# @mode: @CprMode mode
#
# Since: 7.1
##
{ 'command': 'cpr-save',
  'data': { 'filename': 'str',
            'mode': 'CprMode' } }

##
# @cpr-exec:
#
# Restart qemu by directly exec'ing @argv[0], replacing the qemu process.
# The PID remains the same.  Must be called after cpr-save restart.
#
# @argv[0] should be the path of a new qemu binary, or a prefix command that
# in turn exec's the new qemu binary.  The arguments must match those used
# to initially start qemu, plus the -S option so new qemu starts in a paused
# state.
#
# @argv: arguments to be passed to exec().
#
# Since: 7.1
##
{ 'command': 'cpr-exec',
  'data': { 'argv': [ 'str' ] } }

##
# @cpr-load:
#
# Load a virtual machine from the checkpoint file @filename that was created
# earlier by the cpr-save command, and continue the VCPUs.  @mode must match
# the mode specified for cpr-save.
#
# cpr-load requires that qemu was started with -cpr-enable for @mode.
#
# @filename: name of checkpoint file
# @mode: @CprMode mode
#
# Since: 7.1
##
{ 'command': 'cpr-load',
  'data': { 'filename': 'str',
            'mode': 'CprMode' } }
